T OUTER JOIN DS1605_AGNCY        ON DS1605_BTCH.DS1605_BTCH_ID = DS1605_AGNCY.DS1605_BTCH_ID           WHERE DS1605_BTCH.DS1605_BTCH_FY_NUM = @Ds1605BtchFyNum AND       DS1605_AGNCY.AGNCY_NM = fldBureauDesc AND           (CVR_LTR_TYPE.CVR_LTR_TYPE_NM = 'CR' OR                             CVR_LTR_TYPE.CVR_LTR_TYPE_NM = 'BALANCE DUE' OR                             CVR_LTR_TYPE.CVR_LTR_TYPE_NM = 'FINAL')       ORDER BY DS1605_AGNCY.DS1605_AGNCY_CHNG_NUM DESC),     TypeCd = 'S'           FROM ICASS.dbo.vwGDB28StateInvoice           -- Filter any bureaus from Report #28 based on the data that has been          -- marked to to be excluded.        WHERE fldBureau NOT IN                       (SELECT AGNCY_CD                   FROM AGNCY_FILTER               WHERE  AGNCY_FILTER_SLCTD_IND = 1           AND AGNCY_FILTER_TYPE_CD = 'S'             AND AGNCY_FILTER_FY_NUM =  @Ds1605BtchFyNum)           AND fldFiscalYear = @tmpICASSFyNum -- Previous Fiscal Year          AND fldBudgetStage = 4 -- Final Status        GROUP BY fldBureauDesc         ) tblInvoice   WHERE total_amt <> 0 -- only include Total Amounts that are greater than 0.  No reason to                         -- to include budgets that were 0 last fiscal year.   ORDER BY 1, 2           -- CR24369 (05/06/2011)   -- In order for the negative to be set, the TEMP_AGNCY_CD needs to not be null.   -- Since the address information still needs to be set later, only retrieve   -- the agency code here.   UPDATE TEMP_AGNCY       SET TEMP_AGNCY_CD = BUR_ADDR.BUR_ADDR_CD         FROM TEMP_AGNCY, BUR_ADDR            WHERE TEMP_AGNCY.TEMP_AGNCY_NM = BUR_ADDR.BUR_ADDR_NM AND        TEMP_AGNCY.TEMP_AGNCY_TYPE_CD = 'S' AND        CVR_LTR_TYPE_ID = @tmpCRCvrLtrTypeId AND        TEMP_AGNCY_FY_NUM = @Ds1605BtchFyNum     -- Check the previously ran CR's for the FY to see if there are any agencies that were   -- billed in the last run but are not being billed in this run. If so, add them to the   -- TEMP_AGNCY table with a negative amount so their invoice is zeroed out.   INSERT INTO TEMP_AGNCY    (CVR_LTR_TYPE_ID,     TEMP_AGNCY_CD,     TEMP_AGNCY_ICASS_NUM,     TEMP_AGNCY_INV_NUM,       TEMP_AGNCY_AGRMNT_SEQ_NUM,     TEMP_AGNCY_SEQ_NUM,     TEMP_AGNCY_CHNG_NUM,     TEMP_AGNCY_FY_NUM,     TEMP_AGNCY_NEG_IND)       SELECT  @tmpCRCvrLtrTypeId,     AGNCY_CD,           DS1605_AGNCY_ICASS_NUM,            inv_amt,    @tmp_AgrmtnSeqNum,    SeqNum,           ChngNum,     @Ds1605BtchFyNum,    1    FROM          (SELECT AgencyProd.AGNCY_CD,      AgencyProd.DS1605_AGNCY_ICASS_NUM,     (ROUND(SUM(AgencyProd.DS1605_AGNCY_INV_NUM), 0) * -1) as inv_amt,     -- REQ: 3.01.04.01.04 & 3.02.02.02.08     -- Retrieve the last sequence number for the agency code      -- and current fiscal year     SeqNum = (SELECT TOP 1 (DS1605_AGNCY.DS1605_AGNCY_INVC_SEQ_NUM + 1) AS fldNextNum        FROM DS1605_BTCH           LEFT OUTER JOIN DS1605_AGNCY        ON DS1605_BTCH.DS1605_BTCH_ID = DS1605_AGNCY.DS1605_BTCH_ID          WHERE DS1605_BTCH.DS1605_BTCH_FY_NUM = @Ds1605BtchFyNum        AND DS1605_AGNCY.AGNCY_CD = AgencyProd.AGNCY_CD       ORDER BY DS1605_AGNCY.DS1605_AGNCY_INVC_SEQ_NUM DESC),     -- REQ: 3.01.04.01.04, 3.02.02.02.04, 3.02.02.02.05, 3.02.02.02.06     -- Retrieve the last change number for the agency code, current fiscal     -- year, and invoice types     ChngNum = (SELECT TOP 1 (DS1605_AGNCY.DS1605_AGNCY_CHNG_NUM + 1) AS fldNextNum         FROM DS1605_BTCH            INNER JOIN CVR_LTR_TYPE        ON DS1605_BTCH.CVR_LTR_TYPE_ID = CVR_LTR_TYPE.CVR_LTR_TYPE_ID            LEFT OUTER JOIN DS1605_AGNCY        ON DS1605_BTCH.DS1605_BTCH_ID = DS1605_AGNCY.DS1605_BTCH_ID           WHERE DS1605_BTCH.DS1605_BTCH_FY_NUM = @Ds1605BtchFyNum AND       DS1605_AGNCY.AGNCY_CD = AgencyProd.AGNCY_CD AND           (CVR_LTR_TYPE.CVR_LTR_TYPE_NM = 'CR' OR                             CVR_LTR_TYPE.CVR_LTR_TYPE_NM = 'BALANCE DUE' OR                             CVR_LTR_TYPE.CVR_LTR_TYPE_NM = 'FINAL')       ORDER BY DS1605_AGNCY.DS1605_AGNCY_       

